# Helioviewer System Architecture

This document describes the architecture of the Helioviewer System. The focus is on the interaction between the JHelioviewer client and the Helioviewer server.

## Server infrastructure ##

The JHelioviewer and the website clients communicate with the Helioviewer servers using the HTTP network protocol. There are two servers involved:

* the Helioviewer.org web server, which provides basic interaction with the available datasets, constructs the data streams to be served to the JHelioviewer client, and serves the pages of the website client
* the `esajpip` server, which delivers the image data streams to the JHelioviewer client using the JPIP protocol, built on top of the HTTP network protocol

## JPEG2000 infrastructure ##

### JPEG2000 file formats ###
The image data is encoded using the JPEG2000 coding standards. Without going into details beyond the purpose of this document, the data needed by the JHelioviewer client consists of compressed data codestreams organised using *markers* according to a specific syntax, and several file formats, such as JP2 and JPX, which are organised using *boxes* encapsulating the codestreams and the associated information.

In order to ensure the communication between the server and the client, the Helioviewer system imposes a set of constraints on the codestreams and file formats. This includes requirements for codestream organisation such as specific packetisation (PLT markers), coding precincts, and order of progression (RPCL), for file format organisation, such as the presence of specific boxes aggregating the codestreams and the associated information like metadata, and for file naming conventions.

<!-- \hspace{0pt} -->
The JPEG2000 standards have a high degree of sophistication and versatility. In order to encourage the proliferation of Helioviewer image datasets, it should be possible to generate those files with standard conforming software other than the proprietary Kakadu[^kakadu] software currently used. It becomes therefore necessary to formally and automatically validate the full structure of Helioviewer image files. A verification system was developed, composed of the `jpylyzer`[^jpylyzer] software and Schematron[^schematron] XML schemas, to be processed by either `libxslt` or Saxon[^probatron] based XSLT implementations. This procedure is able to verify the JPEG2000 codestream and file structure, including the associated information such as the Helioviewer specific XML metadata, ensuring the end-to-end compatibility with the Helioviewer system. Note that the JP2 files generated by IDL are not standard conforming, as the XML metadata ends with a forbidden NULL character due to a bug in the older versions of Kakadu software embedded in IDL.

<!-- \hspace{0pt} -->
The current Helioviewer system needs to interpret JPEG2000 data at several stages:

1. during the generation of the JP2 files -- until now typically from software code written in IDL
1. during the ingestion into the Helioviewer server -- since the IDL code cannot be configured for the required features, i.e., precincts and PLT markers, the IDL produced JP2 files have to be transcoded
1. the web server itself has to decode the JP2 files in order to serve the image data to its web clients, since those do not typically include JPEG2000 support
1. before the image data is streamed using the JPIP server, it has to be aggregated into JPX files
1. the JHelioviewer client has to decode the codestreams and interpret the associated information

Previously, all those stages involved the proprietary Kakadu software. An alternative solution based on the open source OpenJPEG[^openjpeg] library was developed. This library is freely available in source code form under a license permitting its modification, thus allowed the addition of the required features. Together with `glymur`[^glymur], a Python library that wraps the OpenJPEG library and is able to interpret the JPEG2000 file and codestream formats, the entire server side usage of Kakadu software can be eliminated. The ROB SWHV test server currently runs using this alternative software stack, assembled into a package named `hvJP2K`[^hvJP2K], compatible with Python 2.7 or later.

<!-- \hspace{0pt} -->
For the 1st stage, a C program (`fits2img`) together with a set of patches for OpenJPEG can replace the IDL Kakadu implementation. This C program directly outputs conforming JP2 files, thus the 2nd stage is not needed anymore. It has the additional capability of embedding colormaps inside the JP2 file format. This program is currently being re-written in Python with the help of `glymur`, such that it can be distributed more broadly, possibly within the community's SunPy software library. This will also allow dropping two of the current patches against OpenJPEG: addition of colormaps and XML boxes in the JP2 file headers. Theoretically, the patch for addition of PLT markers into the JPEG2000 codestream could also be re-implemented on top of `glymur`.

The Kakadu's `kdu_transcode` program is used in the 2nd stage for transcoding the IDL produced JP2 files without PLT markers and precincts. This is an old version, modified to output JP2 files, since the vanilla version of `kdu_transcode` is just a demo application for the Kakadu core system and is not able to produce JP2 files. A Python program (`hv_jp2_transcode.py`) was written to wrap the transcoding process. This allows to use an unmodified `kdu_transcode` and thus the Kakadu software on the server can be updated to the latest available.

The 3rd stage (decode JPEG2000 codestreams for the web clients) is replicated by a Python program (`hv_jp2_decode.py`). This comes at the cost of lower performance, but with little impact for the user experience.

The 4th stage (aggregate JPEG2000 codestreams into JPX files) is replaced by another Python based program (`hv_jpx_merge.py`). From the point of view of the JHelioviewer user, the client -- server interaction latency and bandwidth dominates the waiting time for the display of the image data. Additionally, it is now possible to reconstruct JP2 files out of JPX files with embedded codestreams (`hv_jpx_split.py`). Assembly and disassembly of JPX files allows JP2 files heterogeneous from the point of view of size, of component definition, number and type, and of colour specification. Those tasks involve only manipulations at the byte level structure of the file formats and not the decoding of the codestreams.

### JPIP server ###
The `esajpip` server serves the JPEG2000 encoded data to the JHelioviewer client. Besides minor tweaks, this software was ported to a CMake build system and to C++11 standard features. A long-standing bug observed with streaming colormapped JPEG2000 data was eliminated.
